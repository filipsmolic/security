import { HttpInterceptorFn } from "@angular/common/http";

function getVulnerabilityState(): { sql: boolean; access: boolean } {
  const sql = localStorage.getItem("vulnerableSQL") === "true";
  const access = localStorage.getItem("vulnerableAccess") === "true";
  return { sql, access };
}

export const vulnerabilityInterceptor: HttpInterceptorFn = (req, next) => {
  const state = getVulnerabilityState();
  const token = localStorage.getItem("auth_token");

  if (req.url.includes("/api/user/") || req.url.includes("/api/admin/")) {
    const headers: any = {
      "X-Vulnerable-Mode": state.access.toString(),
    };

    if (token) {
      headers["Authorization"] = `Bearer ${token}`;
    }

    const modifiedReq = req.clone({
      setHeaders: headers,
    });

    return next(modifiedReq);
  }

  return next(req);
};
